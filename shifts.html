<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Scheduler Pro - Manual Assign</title>
    <style>
        /* ... (Styles from previous version - mostly the same) ... */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f4; color: #333; }
        .app-shell { display: flex; flex-direction: column; min-height: 100vh; }
        .main-content-area { padding: 20px; display: flex; justify-content: center; align-items: flex-start; flex-grow: 1; }
        .app-container { width: 90%; max-width: 900px; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .manager-dashboard { display: flex; flex-direction: column; width: 100%; min-height: 100vh; }
        .manager-top-bar { background-color: #333; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .manager-top-bar h1 { color: white; margin:0; font-size: 1.5em; }
        .manager-body { display: flex; flex-grow: 1; }
        .manager-sidebar { width: 280px; background-color: #e9ecef; padding: 15px; border-right: 1px solid #ddd; overflow-y: auto; }
        .manager-main-content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .manager-main-flex-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .manager-applications-column { flex: 3; min-width: 0; }
        .manager-hours-column { flex: 1; background-color: #f9f9f9; padding: 15px; border-radius: 5px; border: 1px solid #eee; min-width: 0; }
        .manager-hours-column h3 { margin-top: 0; } .manager-hours-column .input-group select { width: 100%; }
        .manager-schedule-preview { background-color: #fdfdfd; padding:15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #eee;}
        h1, h2, h3, h4 { color: #333; text-align: center; }
        h3 { margin-top: 25px; margin-bottom: 10px;} h4 { margin-top: 15px; margin-bottom: 5px; text-align: left;}
        table { width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        th { background-color: #f0f0f0; }
        td.action-cell { min-width: 200px; text-align: center;} /* May need to be wider for more controls */
        td.action-cell select { margin-bottom: 5px; width: 100%; padding: 5px; font-size: 0.9em;}
        .input-group { margin-bottom: 15px; } .input-group label { display: block; margin-bottom: 5px; }
        .input-group input[type="text"], .input-group input[type="password"], .input-group select { width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.95em; margin-right: 5px; margin-top: 5px; }
        button:hover { background-color: #0056b3; }
        button.approve, button.assign { background-color: #28a745; } /* Assign button same color as approve */
        button.approve:hover, button.assign:hover { background-color: #1e7e34; }
        button.deny, button.delete { background-color: #dc3545; } button.deny:hover, button.delete:hover { background-color: #c82333; }
        button.apply { background-color: #ffc107; color: #333; } button.apply:hover { background-color: #e0a800; }
        button.secondary { background-color: #6c757d; } button.secondary:hover { background-color: #5a6268; }
        button.small-action { padding: 5px 10px; font-size: 0.8em; }
        button.publish { background-color: #17a2b8; } button.publish:hover { background-color: #117a8b; }
        .status-available { color: green; font-weight: bold; } .status-pending { color: orange; font-weight: bold; } .status-approved { color: blue; font-weight: bold; }
        .hidden { display: none !important; }
        #scheduleOverviewTable td, .manager-schedule-preview-table td, #latestPublishedScheduleTable td, #totalHoursSummaryTable td { height: 40px; text-align: left; font-size: 0.9em; }
        #totalHoursSummaryTable th { text-align: left; } #scheduleOverviewTable td, .manager-schedule-preview-table td, #latestPublishedScheduleTable td {text-align: center;} /* Re-center schedule tables */
        .coworker-management-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .coworker-management-item:last-child { border-bottom: none; } .coworker-management-item span { flex-grow: 1; }
        .error-message { color: red; text-align: center; margin-top: 10px; }
        .success-message { color: green; text-align: center; margin-top: 10px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .week-navigation { text-align: center; margin-bottom: 10px; }
        .hours-overview-item { font-size: 0.9em; padding: 3px 0; }
        .published-status-indicator { font-size: 0.8em; font-style: italic; margin-top: 3px; text-align: center; }
        #totalHoursSummarySection { margin-top: 30px; padding-top: 20px; border-top: 2px solid #007bff;}
        #totalHoursSummarySection .input-group select {width: 250px; display: inline-block;}
    </style>
</head>
<body>
    <div class="app-shell">
        <!-- HTML Structure (Same as previous, only managerShiftsTable actions will change in JS) -->
        <div id="initialLoginViewWrapper" class="main-content-area"><div class="app-container"><div id="initialLoginView" class="container view-section"><h1>Shift Scheduler Login</h1><div class="input-group"><label for="loginUserSelect">Select Your Name:</label><select id="loginUserSelect"><option value="">-- Select Name --</option></select></div><div class="input-group"><label for="loginPassword">Password:</label><input type="password" id="loginPassword"></div><button id="coworkerLoginBtn">Login</button><p id="initialLoginError" class="error-message"></p></div></div></div>
        <div id="userShiftViewWrapper" class="main-content-area hidden"><div class="app-container"><div id="latestPublishedScheduleSection" class="container hidden"><h2 id="latestPublishedScheduleTitle">Latest Published Schedule</h2><table id="latestPublishedScheduleTable"><thead><tr><th>Day</th><th>9:30 - 13:00</th><th>13:00 - 16:30</th></tr></thead><tbody></tbody></table></div><div id="userShiftView" class="container view-section"><div class="top-bar"><h2 id="welcomeUserName">Welcome, [User]!</h2><div><button id="accessManagerPanelBtn" class="secondary hidden">Manager Panel</button><button id="userLogoutBtn" class="secondary">Logout</button></div></div><p style="text-align:center;" id="userWeekDisplay">Application Week: </p><h3>Available Shifts & Your Applications</h3><table id="userShiftsTable"><thead><tr><th>Day</th><th>Date</th><th>Time</th><th>Status</th><th>Your Status / Assigned</th><th>Action</th></tr></thead><tbody></tbody></table></div></div></div>
        <div id="managerDashboardView" class="manager-dashboard hidden"><div class="manager-top-bar"><h1>Manager Dashboard</h1><div><span id="managerLoggedInAs" style="margin-right:20px;"></span><button id="switchToUserViewBtn" class="secondary small-action">My Shifts View</button><button id="managerDashboardLogoutBtn" class="secondary small-action">Logout</button></div></div><div class="manager-body"><div class="manager-sidebar"><h4>Week Navigation</h4><div class="week-navigation"><button id="prevWeekBtnMgr" class="small-action">&laquo; Prev Wk</button><button id="jumpToTargetWeekBtnMgr" class="small-action">Next Wk</button><button id="nextWeekBtnMgr" class="small-action">Further Wk &raquo;</button></div><p style="text-align:center; font-size:0.9em; margin-bottom:5px;" id="managerSidebarWeekDisplay"></p><hr><h4>Week Actions</h4><button id="publishWeekBtn" class="publish small-action" style="width:100%; margin-bottom:5px;">Publish Week</button><div id="publishStatusIndicator" class="published-status-indicator">Status: Not Published</div><hr><h4>Admin Settings</h4><button id="showChangeMasterPassBtn" class="secondary small-action" style="width:100%; margin-bottom:10px;">Change Master Password</button><button id="resetAllDataBtn" class="delete small-action" style="width:100%;">Reset All Data</button></div><div class="manager-main-content"><div id="changeMasterPasswordSection" class="container hidden" style="border: 1px solid #ffc107; background: #fff9e6;"><h3>Change Master Admin Password</h3><div class="input-group"><label for="currentMasterPassword">Current Master Password:</label><input type="password" id="currentMasterPassword"></div><div class="input-group"><label for="newMasterPassword">New Master Password:</label><input type="password" id="newMasterPassword"></div><div class="input-group"><label for="confirmNewMasterPassword">Confirm New Password:</label><input type="password" id="confirmNewMasterPassword"></div><button id="submitChangeMasterPassBtn">Change Password</button><button id="cancelChangeMasterPassBtn" class="secondary">Cancel</button><p id="changeMasterPassError" class="error-message"></p><p id="changeMasterPassSuccess" class="success-message"></p></div><div class="manager-schedule-preview"><h3 id="managerSchedulePreviewTitle">Shift Schedule Preview: Week of [Date]</h3><table id="managerSchedulePreviewTable"><thead><tr><th>Day</th><th>9:30 - 13:00</th><th>13:00 - 16:30</th></tr></thead><tbody></tbody></table></div><div class="manager-main-flex-row"><div class="manager-applications-column"><h3>Shift Applications Management</h3><p style="text-align:center; font-size:0.9em;" id="managerApplicationWeekDisplay"></p><table id="managerShiftsTable"><thead><tr><th>Day</th><th>Date</th><th>Time</th><th>Status</th><th>Applicants / Assigned</th><th>Actions</th></tr></thead><tbody></tbody></table></div><div class="manager-hours-column"><h3>Hours Overview</h3><div class="input-group" style="margin-bottom:5px;"><select id="hoursViewTypeSelect"><option value="weekly">Weekly Hours</option><option value="monthly">Monthly Hours</option></select></div><div id="hoursOverviewList"></div></div></div><h3>Manage Coworkers</h3><div class="input-group"><label for="newCoworkerName">Add Name:</label><input type="text" id="newCoworkerName" placeholder="Coworker's name"><label for="newCoworkerPassword" style="margin-top:5px;">Set Password:</label><input type="password" id="newCoworkerPassword" placeholder="Initial password"><label style="margin-top:5px;"><input type="checkbox" id="newCoworkerIsManager"> Is Manager?</label><button id="addCoworkerBtn" style="margin-top:10px;">Add Coworker</button></div><div id="coworkerList"></div><div id="totalHoursSummarySection" class="container"><h3>Total Hours Summary per Coworker</h3><div class="input-group"><label for="totalHoursPeriodSelect" style="display:inline-block; margin-right:10px;">Select Period:</label><select id="totalHoursPeriodSelect"><option value="viewing_week">Currently Viewed Week</option><option value="viewing_month">Currently Viewed Month</option><option value="all_loaded">All Loaded Data</option></select></div><table id="totalHoursSummaryTable"><thead><tr><th>Coworker</th><th>Total Approved Hours</th></tr></thead><tbody></tbody></table></div></div></div></div>
        <div id="managerUnlockModal" class="hidden" style="position:fixed; top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center;"><div style="background:white; padding:30px; border-radius:8px; box-shadow: 0 0 15px rgba(0,0,0,0.3); text-align:center;"><h3>Manager Panel Access</h3><p>Enter Master Admin Password:</p><input type="password" id="masterManagerPasswordInput" style="padding:10px; margin-bottom:15px; width:200px;"><br><button id="unlockManagerPanelBtn">Unlock</button><button id="cancelManagerUnlockBtn" class="secondary">Cancel</button><p id="managerUnlockError" class="error-message"></p></div></div>
    </div>

    <script>
        // Constants (Same as before)
        const DEFAULT_MASTER_PASSWORD = "superadmin";
        const CUSTOM_MASTER_PASSWORD_KEY = "customMasterAdminPassword_v7";
        const ALL_SHIFTS_STORAGE_KEY = "allWeeklyShifts_v7";
        const COWORKERS_STORAGE_KEY = "shiftCoworkers_v7";
        const ACTIVE_SESSION_USER_KEY = "activeShiftUser_v7";
        const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const workDays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
        const shiftTimes = ["9:30 - 13:00", "13:00 - 16:30"];
        const SHIFT_DURATION_HOURS = 3.5;

        // Global Variables (Same as before)
        let currentMasterPassword = DEFAULT_MASTER_PASSWORD;
        let allShiftsData = {};
        let coworkers = [];
        let loggedInCoworker = null;
        let isManagerModeActive = false;
        let currentViewingDateMgr;

        // DOM Elements (Same as before, IDs are preserved)
        const initialLoginViewWrapper = document.getElementById('initialLoginViewWrapper'); const loginUserSelect = document.getElementById('loginUserSelect'); const loginPasswordInput = document.getElementById('loginPassword'); const coworkerLoginBtn = document.getElementById('coworkerLoginBtn'); const initialLoginError = document.getElementById('initialLoginError'); const userShiftViewWrapper = document.getElementById('userShiftViewWrapper'); const latestPublishedScheduleSection = document.getElementById('latestPublishedScheduleSection'); const latestPublishedScheduleTitle = document.getElementById('latestPublishedScheduleTitle'); const latestPublishedScheduleTableBody = document.getElementById('latestPublishedScheduleTable').getElementsByTagName('tbody')[0]; const welcomeUserName = document.getElementById('welcomeUserName'); const accessManagerPanelBtn = document.getElementById('accessManagerPanelBtn'); const userLogoutBtn = document.getElementById('userLogoutBtn'); const userWeekDisplay = document.getElementById('userWeekDisplay'); const userShiftsTableBody = document.getElementById('userShiftsTable').getElementsByTagName('tbody')[0]; const managerUnlockModal = document.getElementById('managerUnlockModal'); const masterManagerPasswordInput = document.getElementById('masterManagerPasswordInput'); const unlockManagerPanelBtn = document.getElementById('unlockManagerPanelBtn'); const cancelManagerUnlockBtn = document.getElementById('cancelManagerUnlockBtn'); const managerUnlockError = document.getElementById('managerUnlockError'); const managerDashboardView = document.getElementById('managerDashboardView'); const managerLoggedInAs = document.getElementById('managerLoggedInAs'); const switchToUserViewBtn = document.getElementById('switchToUserViewBtn'); const managerDashboardLogoutBtn = document.getElementById('managerDashboardLogoutBtn'); const prevWeekBtnMgr = document.getElementById('prevWeekBtnMgr'); const jumpToTargetWeekBtnMgr = document.getElementById('jumpToTargetWeekBtnMgr'); const nextWeekBtnMgr = document.getElementById('nextWeekBtnMgr'); const publishWeekBtn = document.getElementById('publishWeekBtn'); const publishStatusIndicator = document.getElementById('publishStatusIndicator'); const showChangeMasterPassBtn = document.getElementById('showChangeMasterPassBtn'); const changeMasterPasswordSection = document.getElementById('changeMasterPasswordSection'); const currentMasterPasswordInput = document.getElementById('currentMasterPassword'); const newMasterPasswordInput = document.getElementById('newMasterPassword'); const confirmNewMasterPasswordInput = document.getElementById('confirmNewMasterPassword'); const submitChangeMasterPassBtn = document.getElementById('submitChangeMasterPassBtn'); const cancelChangeMasterPassBtn = document.getElementById('cancelChangeMasterPassBtn'); const changeMasterPassError = document.getElementById('changeMasterPassError'); const changeMasterPassSuccess = document.getElementById('changeMasterPassSuccess'); const managerSidebarWeekDisplay = document.getElementById('managerSidebarWeekDisplay'); const hoursViewTypeSelect = document.getElementById('hoursViewTypeSelect');  const hoursOverviewList = document.getElementById('hoursOverviewList');  const resetAllDataBtn = document.getElementById('resetAllDataBtn'); const managerSchedulePreviewTitle = document.getElementById('managerSchedulePreviewTitle'); const managerSchedulePreviewTableBody = document.getElementById('managerSchedulePreviewTable').getElementsByTagName('tbody')[0]; const managerApplicationWeekDisplay = document.getElementById('managerApplicationWeekDisplay'); const managerShiftsTableBody = document.getElementById('managerShiftsTable').getElementsByTagName('tbody')[0]; const newCoworkerNameInput = document.getElementById('newCoworkerName'); const newCoworkerPasswordInput = document.getElementById('newCoworkerPassword'); const newCoworkerIsManagerCheckbox = document.getElementById('newCoworkerIsManager'); const addCoworkerBtn = document.getElementById('addCoworkerBtn'); const coworkerListDiv = document.getElementById('coworkerList'); const totalHoursPeriodSelect = document.getElementById('totalHoursPeriodSelect'); const totalHoursSummaryTableBody = document.getElementById('totalHoursSummaryTable').getElementsByTagName('tbody')[0];

        // --- Date & Utility Functions --- (Same as before)
        function getMondayOfDate(d) { d = new Date(d); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); const monday = new Date(d.setDate(diff)); monday.setHours(0,0,0,0); return monday; }
        function getNextWeekStartDate(fromDate = new Date()) { const monday = getMondayOfDate(fromDate); monday.setDate(monday.getDate() + 7); return monday; }
        function formatDate(dateObj, includeDayName = true) { if (!dateObj || !(dateObj instanceof Date) || isNaN(dateObj.getTime())) return 'Invalid Date'; const dayStr = includeDayName ? `${dayNames[dateObj.getDay()]}, ` : ''; return `${dayStr}${dateObj.toLocaleString('default', { month: 'short' })} ${dateObj.getDate()}, ${dateObj.getFullYear()}`; }
        function getWeekKey(dateObj) { return getMondayOfDate(dateObj).toISOString().split('T')[0]; }
        
        // --- Initialization --- (Same as before)
        function initializeApp() { loadMasterPassword(); currentViewingDateMgr = getNextWeekStartDate(); initializeCoworkers(); loadAllShiftsData(); populateLoginUserDropdown(); checkActiveSession(); }
        function loadMasterPassword() { const storedMasterPass = localStorage.getItem(CUSTOM_MASTER_PASSWORD_KEY); if (storedMasterPass) { currentMasterPassword = storedMasterPass; } else { currentMasterPassword = DEFAULT_MASTER_PASSWORD; } }
        function loadAllShiftsData() { const stored = localStorage.getItem(ALL_SHIFTS_STORAGE_KEY); allShiftsData = stored ? JSON.parse(stored) : {}; for (const weekKey in allShiftsData) { if (typeof allShiftsData[weekKey].isPublished === 'undefined') { allShiftsData[weekKey].isPublished = false; } if (!allShiftsData[weekKey].shifts) { allShiftsData[weekKey] = { shifts: allShiftsData[weekKey], isPublished: false }; } allShiftsData[weekKey].shifts.forEach(shift => { if (shift.applicants === undefined) shift.applicants = []; }); } }
        function saveAllShiftsData() { localStorage.setItem(ALL_SHIFTS_STORAGE_KEY, JSON.stringify(allShiftsData)); }
        function getWeekData(weekStartDate) { const weekKey = getWeekKey(weekStartDate); if (!allShiftsData[weekKey]) { const newWeekShifts = []; let idCounter = Date.now(); for (let i = 0; i < workDays.length; i++) { const dayName = workDays[i]; const shiftDate = new Date(weekStartDate); shiftDate.setDate(weekStartDate.getDate() + i); shiftTimes.forEach(time => { newWeekShifts.push({ id: `${weekKey}-${idCounter++}`, day: dayName, date: shiftDate.toISOString(), time: time, status: "available", applicants: [], applicantName: "" }); }); } allShiftsData[weekKey] = { shifts: newWeekShifts, isPublished: false }; saveAllShiftsData(); } return allShiftsData[weekKey]; }
        function getShiftsForWeek(weekStartDate) { return getWeekData(weekStartDate).shifts; }
        function initializeCoworkers() { const stored = localStorage.getItem(COWORKERS_STORAGE_KEY); if (stored) { coworkers = JSON.parse(stored); coworkers.forEach(c => { if (c.isManager === undefined) c.isManager = false; }); } else { coworkers = [ { name: "Ties", password: "1234", isManager: true }, { name: "Joep", password: "1234", isManager: false }, { name: "Jesper", password: "1234", isManager: false }, { name: "Inti", password: "1234", isManager: false }, { name: "Martijn", password: "1234", isManager: false }, { name: "Mathijs", password: "1234", isManager: false }, { name: "Dominik", password: "1234", isManager: false }, { name: "Jippe", password: "1234", isManager: false }, { name: "Zeynep", password: "1234", isManager: false } ]; saveCoworkers(); } }
        function saveCoworkers() { localStorage.setItem(COWORKERS_STORAGE_KEY, JSON.stringify(coworkers)); }

        // --- View Switching & Session --- (Same as before)
        function showCorrectView() { [initialLoginViewWrapper, userShiftViewWrapper, managerDashboardView, managerUnlockModal, changeMasterPasswordSection].forEach(v => v.classList.add('hidden')); if (isManagerModeActive && loggedInCoworker && loggedInCoworker.isManager) { managerDashboardView.classList.remove('hidden'); managerLoggedInAs.textContent = `Logged in as: ${loggedInCoworker.name}`; refreshManagerDashboard(); } else if (loggedInCoworker) { userShiftViewWrapper.classList.remove('hidden'); prepareUserView(); } else { initialLoginViewWrapper.classList.remove('hidden'); } }
        function checkActiveSession() { const activeUserJSON = localStorage.getItem(ACTIVE_SESSION_USER_KEY); if (activeUserJSON) { const activeUser = JSON.parse(activeUserJSON); const foundCoworker = coworkers.find(c => c.name === activeUser.name); if (foundCoworker) { if(activeUser.password === foundCoworker.password){ loggedInCoworker = foundCoworker; } else { logout(); return; } } else { logout(); return; } } showCorrectView(); }
        function populateLoginUserDropdown() { loginUserSelect.innerHTML = '<option value="">-- Select Name --</option>'; coworkers.sort((a, b) => a.name.localeCompare(b.name)).forEach(coworker => { const option = document.createElement('option'); option.value = coworker.name; option.textContent = coworker.name; loginUserSelect.appendChild(option); }); }
        
        // --- Login/Logout & Manager Unlock --- (Same as before)
        function handleCoworkerLogin() { const selectedName = loginUserSelect.value; const password = loginPasswordInput.value; initialLoginError.textContent = ""; if (!selectedName || !password) { initialLoginError.textContent = "Name and password are required."; return; } const coworker = coworkers.find(c => c.name === selectedName); if (coworker && coworker.password === password) { loggedInCoworker = coworker; localStorage.setItem(ACTIVE_SESSION_USER_KEY, JSON.stringify({name: coworker.name, password: coworker.password})); loginPasswordInput.value = ""; isManagerModeActive = false; showCorrectView(); } else { initialLoginError.textContent = "Invalid name or password."; loginPasswordInput.value = ""; } }
        function handleAccessManagerPanel() { if (loggedInCoworker && loggedInCoworker.isManager) { managerUnlockModal.classList.remove('hidden'); masterManagerPasswordInput.value = ""; managerUnlockError.textContent = ""; masterManagerPasswordInput.focus(); } }
        function handleUnlockManagerPanel() { if (masterManagerPasswordInput.value === currentMasterPassword) { isManagerModeActive = true; managerUnlockModal.classList.add('hidden'); showCorrectView(); } else { managerUnlockError.textContent = "Incorrect Master Password."; } }
        function logout() { loggedInCoworker = null; isManagerModeActive = false; localStorage.removeItem(ACTIVE_SESSION_USER_KEY); loginPasswordInput.value = ""; masterManagerPasswordInput.value = ""; initialLoginError.textContent = ""; managerUnlockError.textContent = ""; changeMasterPasswordSection.classList.add('hidden'); showCorrectView(); }
        function prepareUserView() { welcomeUserName.textContent = `Welcome, ${loggedInCoworker.name}!`; accessManagerPanelBtn.classList.toggle('hidden', !loggedInCoworker.isManager); const publishedWeeks = Object.keys(allShiftsData).filter(weekKey => allShiftsData[weekKey].isPublished).sort((a,b) => new Date(b) - new Date(a)); if (publishedWeeks.length > 0) { const latestPublishedWeekKey = publishedWeeks[0]; const latestPublishedWeekData = allShiftsData[latestPublishedWeekKey]; latestPublishedScheduleTitle.textContent = `Latest Published Schedule: Week of ${formatDate(new Date(latestPublishedWeekKey), false)}`; renderScheduleOverview(latestPublishedWeekData.shifts, latestPublishedScheduleTableBody); latestPublishedScheduleSection.classList.remove('hidden'); } else { latestPublishedScheduleSection.classList.add('hidden'); } const applicationWeekStartDate = getNextWeekStartDate(); userWeekDisplay.textContent = `Application Week: ${formatDate(applicationWeekStartDate, false)}`; const shiftsToDisplayForApplication = getShiftsForWeek(applicationWeekStartDate); renderUserShifts(shiftsToDisplayForApplication, applicationWeekStartDate); }

        // --- Rendering Logic ---
        function renderUserShifts(shiftsForWeek, forWeekDate) { /* ... (same as before) ... */ userShiftsTableBody.innerHTML = ""; shiftsForWeek.forEach(shift => { const row = userShiftsTableBody.insertRow(); row.insertCell().textContent = shift.day; row.insertCell().textContent = formatDate(new Date(shift.date), false); row.insertCell().textContent = shift.time; const statusCell = row.insertCell(); const applicantsAssignedCell = row.insertCell(); const actionCell = row.insertCell(); const isMyAppPending = shift.status === 'pending' && shift.applicants.includes(loggedInCoworker.name); const isApproved = shift.status === 'approved'; if (isApproved) { statusCell.textContent = "Approved"; statusCell.className = 'status-approved'; applicantsAssignedCell.textContent = shift.applicantName; actionCell.textContent = "---"; } else if (isMyAppPending) { statusCell.textContent = "Pending"; statusCell.className = 'status-pending'; applicantsAssignedCell.textContent = loggedInCoworker.name; const cancelBtn = document.createElement('button'); cancelBtn.textContent = "Cancel App"; cancelBtn.classList.add("deny"); cancelBtn.onclick = () => cancelApplication(shift.id, getWeekKey(forWeekDate)); actionCell.appendChild(cancelBtn); } else { statusCell.textContent = "Available"; statusCell.className = 'status-available'; applicantsAssignedCell.textContent = "---"; const applyButton = document.createElement('button'); applyButton.textContent = "Apply"; applyButton.classList.add("apply"); applyButton.onclick = () => applyForShift(shift.id, getWeekKey(forWeekDate)); actionCell.appendChild(applyButton); } }); }
        function renderScheduleOverview(shiftsForWeek, tableBodyElement) { /* ... (same as before) ... */ tableBodyElement.innerHTML = ""; const scheduleData = {}; workDays.forEach(day => { scheduleData[day] = {}; shiftTimes.forEach(time => scheduleData[day][time] = "Unassigned"); }); shiftsForWeek.filter(s => s.status === "approved").forEach(shift => { if (scheduleData[shift.day]) scheduleData[shift.day][shift.time] = shift.applicantName; }); workDays.forEach(day => { const row = tableBodyElement.insertRow(); const dayCell = row.insertCell(); const shiftOnThisDay = shiftsForWeek.find(s => s.day === day); dayCell.innerHTML = `${day}<br><small>${shiftOnThisDay ? formatDate(new Date(shiftOnThisDay.date), false) : ''}</small>`; shiftTimes.forEach(time => { const cell = row.insertCell(); cell.textContent = scheduleData[day][time] || "Unassigned"; if (scheduleData[day][time] && scheduleData[day][time] !== "Unassigned") { cell.style.fontWeight = "bold"; } }); }); }
        function refreshManagerDashboard() { if (!isManagerModeActive) return; const weekData = getWeekData(currentViewingDateMgr); const shiftsForViewingWeek = weekData.shifts; managerSidebarWeekDisplay.textContent = `Week: ${formatDate(currentViewingDateMgr, false)}`; managerApplicationWeekDisplay.textContent = `Apps for week: ${formatDate(currentViewingDateMgr, false)}`; managerSchedulePreviewTitle.textContent = `Schedule: Week of ${formatDate(currentViewingDateMgr, false)}`; renderManagerApplications(shiftsForViewingWeek); renderScheduleOverview(shiftsForViewingWeek, managerSchedulePreviewTableBody); renderCoworkerListForManager(); renderHoursOverview(); renderTotalHoursSummary(); if (weekData.isPublished) { publishWeekBtn.textContent = "Unpublish Week"; publishWeekBtn.classList.remove("publish"); publishWeekBtn.classList.add("deny"); publishStatusIndicator.textContent = "Status: Published"; publishStatusIndicator.style.color = "green"; } else { publishWeekBtn.textContent = "Publish Week"; publishWeekBtn.classList.add("publish"); publishWeekBtn.classList.remove("deny"); publishStatusIndicator.textContent = "Status: Not Published"; publishStatusIndicator.style.color = "orange"; } }
        
        function renderManagerApplications(shiftsForWeek) {
            managerShiftsTableBody.innerHTML = "";
            shiftsForWeek.forEach(shift => {
                const row = managerShiftsTableBody.insertRow();
                row.insertCell().textContent = shift.day;
                row.insertCell().textContent = formatDate(new Date(shift.date), false);
                row.insertCell().textContent = shift.time;
                const statusCell = row.insertCell();
                statusCell.textContent = shift.status.charAt(0).toUpperCase() + shift.status.slice(1);
                statusCell.className = `status-${shift.status}`;

                let applicantDisplay = "---";
                if (shift.status === "pending" && shift.applicants && shift.applicants.length > 0) {
                    applicantDisplay = shift.applicants.join(', ');
                } else if (shift.status === "approved") {
                    applicantDisplay = shift.applicantName;
                }
                row.insertCell().textContent = applicantDisplay;
                
                const actionCell = row.insertCell();
                actionCell.classList.add("action-cell");
                const weekKey = getWeekKey(new Date(shift.date));

                // Controls for Pending shifts
                if (shift.status === "pending" && shift.applicants && shift.applicants.length > 0) {
                    const applicantSelect = document.createElement('select');
                    applicantSelect.id = `select-pending-${shift.id}`;
                    shift.applicants.forEach(appName => {
                        const option = document.createElement('option');
                        option.value = appName; option.textContent = appName;
                        applicantSelect.appendChild(option);
                    });
                    actionCell.appendChild(applicantSelect);

                    const approveSelectedBtn = document.createElement('button');
                    approveSelectedBtn.textContent = "Approve Sel.";
                    approveSelectedBtn.classList.add("approve", "small-action");
                    approveSelectedBtn.onclick = () => {
                        const selectedName = document.getElementById(`select-pending-${shift.id}`).value;
                        managerApproveSelectedApplicant(shift.id, weekKey, selectedName);
                    };
                    actionCell.appendChild(approveSelectedBtn);

                    const denyAllBtn = document.createElement('button');
                    denyAllBtn.textContent = "Deny All";
                    denyAllBtn.classList.add("deny", "small-action");
                    denyAllBtn.style.marginLeft = "5px";
                    denyAllBtn.onclick = () => managerDenyAllApplicants(shift.id, weekKey);
                    actionCell.appendChild(denyAllBtn);
                } 
                // Controls for Approved shifts
                else if (shift.status === "approved") {
                    const clearBtn = document.createElement('button');
                    clearBtn.textContent = "Clear"; clearBtn.classList.add("deny", "small-action");
                    clearBtn.onclick = () => managerClearApprovedShift(shift.id, weekKey);
                    actionCell.appendChild(clearBtn);

                    // Add a divider or space before manual assign for clarity
                    actionCell.appendChild(document.createElement('hr')); 
                }
                // Manual Assign for Available or Approved shifts (to re-assign)
                if (shift.status === "available" || shift.status === "approved") {
                     const manualAssignSelect = document.createElement('select');
                     manualAssignSelect.id = `select-manual-${shift.id}`;
                     manualAssignSelect.innerHTML = '<option value="">-- Assign To --</option>'; // Placeholder
                     coworkers.forEach(cw => {
                        const option = document.createElement('option');
                        option.value = cw.name; option.textContent = cw.name;
                        manualAssignSelect.appendChild(option);
                     });
                     actionCell.appendChild(manualAssignSelect);

                     const manualAssignBtn = document.createElement('button');
                     manualAssignBtn.textContent = "Assign";
                     manualAssignBtn.classList.add("assign", "small-action");
                     manualAssignBtn.onclick = () => {
                        const selectedName = document.getElementById(`select-manual-${shift.id}`).value;
                        if (selectedName) {
                            managerManuallyAssignShift(shift.id, weekKey, selectedName);
                        } else {
                            alert("Please select a coworker to assign.");
                        }
                     };
                     actionCell.appendChild(manualAssignBtn);
                }
            });
        }
        function renderHoursOverview() { /* ... (same as before) ... */ hoursOverviewList.innerHTML = ""; const type = hoursViewTypeSelect.value; const hoursData = {}; coworkers.forEach(c => hoursData[c.name] = 0); if (type === "weekly") { const shiftsForWeek = getShiftsForWeek(currentViewingDateMgr); shiftsForWeek.filter(s => s.status === "approved" && s.applicantName).forEach(s => { if (hoursData.hasOwnProperty(s.applicantName)) { hoursData[s.applicantName] += SHIFT_DURATION_HOURS; } }); } else if (type === "monthly") { const targetMonth = currentViewingDateMgr.getMonth(); const targetYear = currentViewingDateMgr.getFullYear(); for (const weekKey in allShiftsData) { if (!allShiftsData[weekKey].shifts) continue; const weekStartDate = new Date(weekKey); if (weekStartDate.getMonth() === targetMonth && weekStartDate.getFullYear() === targetYear) { allShiftsData[weekKey].shifts.filter(s => s.status === "approved" && s.applicantName).forEach(s => { if (hoursData.hasOwnProperty(s.applicantName)) { hoursData[s.applicantName] += SHIFT_DURATION_HOURS; } }); } } } const sortedCoworkers = Object.keys(hoursData).sort(); sortedCoworkers.forEach(name => { const item = document.createElement('div'); item.classList.add('hours-overview-item'); item.textContent = `${name}: ${hoursData[name].toFixed(1)} hrs`; hoursOverviewList.appendChild(item); }); }
        function renderTotalHoursSummary() { /* ... (same as before) ... */ totalHoursSummaryTableBody.innerHTML = ""; const period = totalHoursPeriodSelect.value; const summaryData = {}; coworkers.forEach(c => summaryData[c.name] = 0); let shiftsToConsider = []; if (period === "viewing_week") { shiftsToConsider = getShiftsForWeek(currentViewingDateMgr); } else if (period === "viewing_month") { const targetMonth = currentViewingDateMgr.getMonth(); const targetYear = currentViewingDateMgr.getFullYear(); for (const weekKey in allShiftsData) { if (!allShiftsData[weekKey].shifts) continue; const weekStartDate = new Date(weekKey); if (weekStartDate.getMonth() === targetMonth && weekStartDate.getFullYear() === targetYear) { shiftsToConsider = shiftsToConsider.concat(allShiftsData[weekKey].shifts); } } } else if (period === "all_loaded") { for (const weekKey in allShiftsData) { if (!allShiftsData[weekKey].shifts) continue; shiftsToConsider = shiftsToConsider.concat(allShiftsData[weekKey].shifts); } } shiftsToConsider.filter(s => s.status === "approved" && s.applicantName).forEach(s => { if (summaryData.hasOwnProperty(s.applicantName)) { summaryData[s.applicantName] += SHIFT_DURATION_HOURS; } }); const sortedCoworkerNames = Object.keys(summaryData).sort(); sortedCoworkerNames.forEach(name => { const row = totalHoursSummaryTableBody.insertRow(); row.insertCell().textContent = name; row.insertCell().textContent = summaryData[name].toFixed(1) + " hrs"; }); }

        // --- Shift Actions (User & Manager) ---
        function findShiftInWeek(weekKey, shiftId) { if (!allShiftsData[weekKey] || !allShiftsData[weekKey].shifts) return null; return allShiftsData[weekKey].shifts.find(s => s.id === shiftId); }
        function applyForShift(shiftId, weekKey) { const shift = findShiftInWeek(weekKey, shiftId); if (shift && loggedInCoworker) { const isMyAppPending = shift.status === 'pending' && shift.applicants.includes(loggedInCoworker.name); if (shift.status !== 'approved' && !isMyAppPending) { if (!shift.applicants.includes(loggedInCoworker.name)) { shift.applicants.push(loggedInCoworker.name); } shift.status = "pending"; shift.applicantName = ""; saveAllShiftsData(); prepareUserView(); if (isManagerModeActive && weekKey === getWeekKey(currentViewingDateMgr)) { refreshManagerDashboard(); } } } }
        function cancelApplication(shiftId, weekKey) { const shift = findShiftInWeek(weekKey, shiftId); if (shift && shift.status === "pending" && loggedInCoworker && shift.applicants) { const index = shift.applicants.indexOf(loggedInCoworker.name); if (index > -1) { shift.applicants.splice(index, 1); } if (shift.applicants.length === 0) { shift.status = "available"; } saveAllShiftsData(); prepareUserView(); if (isManagerModeActive && weekKey === getWeekKey(currentViewingDateMgr)) { refreshManagerDashboard(); } } }
        function managerApproveSelectedApplicant(shiftId, weekKey, selectedApplicantName) { const shift = findShiftInWeek(weekKey, shiftId); if (shift && shift.status === "pending") { shift.status = "approved"; shift.applicantName = selectedApplicantName; shift.applicants = []; saveAllShiftsData(); refreshManagerDashboard(); prepareUserView(); } }
        function managerDenyAllApplicants(shiftId, weekKey) { const shift = findShiftInWeek(weekKey, shiftId); if (shift && shift.status === "pending") { shift.status = "available"; shift.applicantName = ""; shift.applicants = []; saveAllShiftsData(); refreshManagerDashboard(); prepareUserView(); } }
        function managerClearApprovedShift(shiftId, weekKey) { const shift = findShiftInWeek(weekKey, shiftId); if (shift && shift.status === "approved") { shift.status = "available"; shift.applicantName = ""; shift.applicants = []; saveAllShiftsData(); refreshManagerDashboard(); prepareUserView(); } }
        
        function managerManuallyAssignShift(shiftId, weekKey, coworkerName) {
            const shift = findShiftInWeek(weekKey, shiftId);
            if (shift) {
                shift.status = "approved";
                shift.applicantName = coworkerName;
                shift.applicants = []; // Clear any pending applicants for this slot
                saveAllShiftsData();
                refreshManagerDashboard();
                prepareUserView(); // Update user view in case they are the one assigned or it affects published view
            }
        }
        
        function handlePublishWeekToggle() { const weekKey = getWeekKey(currentViewingDateMgr); if (allShiftsData[weekKey]) { allShiftsData[weekKey].isPublished = !allShiftsData[weekKey].isPublished; saveAllShiftsData(); refreshManagerDashboard(); prepareUserView(); alert(`Week of ${formatDate(currentViewingDateMgr, false)} has been ${allShiftsData[weekKey].isPublished ? 'Published' : 'Unpublished'}.`); } }
        
        // --- Manager: Coworker Management & Master Password --- (Same as before, just ensure all functions are present)
        function renderCoworkerListForManager() { coworkerListDiv.innerHTML = "<h4>Current Coworkers:</h4>"; if (coworkers.length === 0) { coworkerListDiv.innerHTML += "<p>No coworkers.</p>"; return; } const ul = document.createElement('ul'); ul.style.listStyleType = 'none'; ul.style.paddingLeft = '0'; coworkers.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => { const li = document.createElement('li'); li.classList.add('coworker-management-item'); const nameSpan = document.createElement('span'); nameSpan.textContent = `${c.name} ${c.isManager ? '(Mgr)' : ''}`; li.appendChild(nameSpan); const actionDiv = document.createElement('div'); const changePassBtn = document.createElement('button'); changePassBtn.textContent = "Pwd"; changePassBtn.classList.add("secondary", "small-action"); changePassBtn.onclick = () => handleChangeCoworkerPassword(c.name); actionDiv.appendChild(changePassBtn); const toggleMgrBtn = document.createElement('button'); toggleMgrBtn.textContent = c.isManager ? "Demote" : "Promote"; toggleMgrBtn.classList.add("secondary", "small-action"); toggleMgrBtn.onclick = () => handleToggleManagerStatus(c.name); actionDiv.appendChild(toggleMgrBtn); const deleteBtn = document.createElement('button'); deleteBtn.textContent = "Del"; deleteBtn.classList.add("delete", "small-action"); deleteBtn.onclick = () => handleDeleteCoworker(c.name); actionDiv.appendChild(deleteBtn); li.appendChild(actionDiv); ul.appendChild(li); }); coworkerListDiv.appendChild(ul); }
        function handleAddCoworker() { const name = newCoworkerNameInput.value.trim(); const password = newCoworkerPasswordInput.value; const isManager = newCoworkerIsManagerCheckbox.checked; if (!name || !password) { alert("Name and password required."); return; } if (coworkers.find(c => c.name.toLowerCase() === name.toLowerCase())) { alert("Coworker name already exists."); return; } coworkers.push({ name, password, isManager }); saveCoworkers(); populateLoginUserDropdown(); renderCoworkerListForManager(); newCoworkerNameInput.value = ""; newCoworkerPasswordInput.value = ""; newCoworkerIsManagerCheckbox.checked = false; alert(`${name} added.`); }
        function handleDeleteCoworker(nameToDelete) { if (loggedInCoworker && loggedInCoworker.name === nameToDelete && loggedInCoworker.isManager && coworkers.filter(c => c.isManager).length <= 1) { alert("Cannot delete the last manager."); return; } if (confirm(`Delete ${nameToDelete}? Their name will be removed from all shift applications and assignments.`)) { coworkers = coworkers.filter(c => c.name !== nameToDelete); saveCoworkers(); for (const weekKey in allShiftsData) { if (!allShiftsData[weekKey].shifts) continue; allShiftsData[weekKey].shifts.forEach(shift => { if (shift.applicantName === nameToDelete) { shift.applicantName = ""; shift.status = "available"; } if (shift.applicants && shift.applicants.includes(nameToDelete)) { shift.applicants = shift.applicants.filter(name => name !== nameToDelete); if (shift.status === "pending" && shift.applicants.length === 0) { shift.status = "available"; } } }); } saveAllShiftsData(); populateLoginUserDropdown(); if (loggedInCoworker && loggedInCoworker.name === nameToDelete) logout(); else if(isManagerModeActive) refreshManagerDashboard(); prepareUserView(); } }
        function handleChangeCoworkerPassword(name) { const newPass = prompt(`New password for ${name}:`); if (newPass === null) return; if (!newPass.trim()) { alert("Password cannot be empty."); return; } const coworker = coworkers.find(c => c.name === name); if (coworker) { coworker.password = newPass.trim(); saveCoworkers(); alert(`Password for ${name} updated.`); if (loggedInCoworker && loggedInCoworker.name === name) { loggedInCoworker.password = newPass.trim(); localStorage.setItem(ACTIVE_SESSION_USER_KEY, JSON.stringify({name: loggedInCoworker.name, password: loggedInCoworker.password})); } } }
        function handleToggleManagerStatus(name) { const coworker = coworkers.find(c => c.name === name); if (coworker) { if (coworker.isManager && coworkers.filter(c => c.isManager).length <= 1) { alert("Cannot remove manager status from the last manager."); return; } coworker.isManager = !coworker.isManager; saveCoworkers(); renderCoworkerListForManager(); if (loggedInCoworker && loggedInCoworker.name === name) { loggedInCoworker.isManager = coworker.isManager; accessManagerPanelBtn.classList.toggle('hidden', !loggedInCoworker.isManager); if (!loggedInCoworker.isManager && isManagerModeActive) { isManagerModeActive = false; showCorrectView(); } } } }
        function handleSubmitChangeMasterPassword() { changeMasterPassError.textContent = ""; changeMasterPassSuccess.textContent = ""; const currentPass = currentMasterPasswordInput.value; const newPass = newMasterPasswordInput.value; const confirmPass = confirmNewMasterPasswordInput.value; if (currentPass !== currentMasterPassword) { changeMasterPassError.textContent = "Current Master Password incorrect."; return; } if (!newPass || newPass.length < 6) { changeMasterPassError.textContent = "New password must be at least 6 characters."; return; } if (newPass !== confirmPass) { changeMasterPassError.textContent = "New passwords do not match."; return; } currentMasterPassword = newPass; localStorage.setItem(CUSTOM_MASTER_PASSWORD_KEY, newPass); changeMasterPassSuccess.textContent = "Master Admin Password changed successfully!"; currentMasterPasswordInput.value = ""; newMasterPasswordInput.value = ""; confirmNewMasterPasswordInput.value = ""; setTimeout(() => { changeMasterPasswordSection.classList.add('hidden'); changeMasterPassSuccess.textContent = ""; }, 2000); }
        function handleResetAllData() { if (confirm("RESET ALL DATA (shifts, coworkers, session, AND CUSTOM MASTER PASSWORD)? This cannot be undone!")) { localStorage.removeItem(ALL_SHIFTS_STORAGE_KEY); localStorage.removeItem(COWORKERS_STORAGE_KEY); localStorage.removeItem(ACTIVE_SESSION_USER_KEY); localStorage.removeItem(CUSTOM_MASTER_PASSWORD_KEY); allShiftsData = {}; coworkers = []; loggedInCoworker = null; isManagerModeActive = false; initializeApp(); alert("All data reset. Please login."); } }
        
        // --- Event Listeners ---
        coworkerLoginBtn.addEventListener('click', handleCoworkerLogin); loginPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleCoworkerLogin(); }); accessManagerPanelBtn.addEventListener('click', handleAccessManagerPanel); userLogoutBtn.addEventListener('click', logout); unlockManagerPanelBtn.addEventListener('click', handleUnlockManagerPanel); masterManagerPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleUnlockManagerPanel(); }); cancelManagerUnlockBtn.addEventListener('click', () => managerUnlockModal.classList.add('hidden')); switchToUserViewBtn.addEventListener('click', () => { isManagerModeActive = false; changeMasterPasswordSection.classList.add('hidden'); showCorrectView(); }); managerDashboardLogoutBtn.addEventListener('click', logout); prevWeekBtnMgr.addEventListener('click', () => { currentViewingDateMgr.setDate(currentViewingDateMgr.getDate() - 7); refreshManagerDashboard(); });
        jumpToTargetWeekBtnMgr.addEventListener('click', () => { currentViewingDateMgr = getNextWeekStartDate(); refreshManagerDashboard(); });
        nextWeekBtnMgr.addEventListener('click', () => { currentViewingDateMgr.setDate(currentViewingDateMgr.getDate() + 7); refreshManagerDashboard(); });
        publishWeekBtn.addEventListener('click', handlePublishWeekToggle); showChangeMasterPassBtn.addEventListener('click', () => { changeMasterPasswordSection.classList.toggle('hidden'); changeMasterPassError.textContent = ""; changeMasterPassSuccess.textContent = ""; currentMasterPasswordInput.value = ""; newMasterPasswordInput.value = ""; confirmNewMasterPasswordInput.value = ""; }); submitChangeMasterPassBtn.addEventListener('click', handleSubmitChangeMasterPassword); cancelChangeMasterPassBtn.addEventListener('click', () => { changeMasterPasswordSection.classList.add('hidden'); changeMasterPassError.textContent = ""; changeMasterPassSuccess.textContent = ""; }); hoursViewTypeSelect.addEventListener('change', renderHoursOverview);
        totalHoursPeriodSelect.addEventListener('change', renderTotalHoursSummary);
        resetAllDataBtn.addEventListener('click', handleResetAllData); addCoworkerBtn.addEventListener('click', handleAddCoworker); newCoworkerPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddCoworker(); });
        
        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>