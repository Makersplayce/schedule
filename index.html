<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Scheduler Pro - Full Firebase</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f4; color: #333; }
        .app-shell { display: flex; flex-direction: column; min-height: 100vh; }
        .main-content-area { padding: 20px; display: flex; justify-content: center; align-items: flex-start; flex-grow: 1; }
        .app-container { width: 90%; max-width: 900px; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .manager-dashboard { display: flex; flex-direction: column; width: 100%; min-height: 100vh; }
        .manager-top-bar { background-color: #333; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .manager-top-bar h1 { color: white; margin:0; font-size: 1.5em; }
        .manager-body { display: flex; flex-grow: 1; }
        .manager-sidebar { width: 280px; background-color: #e9ecef; padding: 15px; border-right: 1px solid #ddd; overflow-y: auto; }
        .manager-main-content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .manager-main-flex-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .manager-applications-column { flex: 3; min-width: 0; }
        .manager-hours-column { flex: 1; background-color: #f9f9f9; padding: 15px; border-radius: 5px; border: 1px solid #eee; min-width: 0; }
        .manager-hours-column h3 { margin-top: 0; } .manager-hours-column .input-group select { width: 100%; }
        .manager-schedule-preview { background-color: #fdfdfd; padding:15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #eee;}
        h1, h2, h3, h4 { color: #333; text-align: center; }
        h3 { margin-top: 25px; margin-bottom: 10px;} h4 { margin-top: 15px; margin-bottom: 5px; text-align: left;}
        table { width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        th { background-color: #f0f0f0; }
        td.action-cell { min-width: 200px; text-align: center;}
        td.action-cell select { margin-bottom: 5px; width: 100%; padding: 5px; font-size: 0.9em;}
        .input-group { margin-bottom: 15px; } .input-group label { display: block; margin-bottom: 5px; }
        .input-group input[type="text"], .input-group input[type="password"], .input-group select { width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.95em; margin-right: 5px; margin-top: 5px; }
        button:hover { background-color: #0056b3; }
        button.approve, button.assign { background-color: #28a745; } 
        button.approve:hover, button.assign:hover { background-color: #1e7e34; }
        button.deny, button.delete { background-color: #dc3545; } button.deny:hover, button.delete:hover { background-color: #c82333; }
        button.apply { background-color: #ffc107; color: #333; } button.apply:hover { background-color: #e0a800; }
        button.secondary { background-color: #6c757d; } button.secondary:hover { background-color: #5a6268; }
        button.small-action { padding: 5px 10px; font-size: 0.8em; }
        button.publish { background-color: #17a2b8; } button.publish:hover { background-color: #117a8b; }
        .status-available { color: green; font-weight: bold; } .status-pending { color: orange; font-weight: bold; } .status-approved { color: blue; font-weight: bold; }
        .hidden { display: none !important; }
        #scheduleOverviewTable td, .manager-schedule-preview-table td, #latestPublishedScheduleTable td {text-align: center;}
        #totalHoursSummaryTable td, #totalHoursSummaryTable th { text-align: left; font-size: 0.9em; }
        .coworker-management-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .coworker-management-item:last-child { border-bottom: none; } .coworker-management-item span { flex-grow: 1; }
        .error-message { color: red; text-align: center; margin-top: 10px; }
        .success-message { color: green; text-align: center; margin-top: 10px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .week-navigation { text-align: center; margin-bottom: 10px; }
        .hours-overview-item { font-size: 0.9em; padding: 3px 0; }
        .published-status-indicator { font-size: 0.8em; font-style: italic; margin-top: 3px; text-align: center; }
        #totalHoursSummarySection { margin-top: 30px; padding-top: 20px; border-top: 2px solid #007bff;}
        #totalHoursSummarySection .input-group select {width: 250px; display: inline-block;}
    </style>
</head>
<body>
    <div class="app-shell">
        <div id="initialLoginViewWrapper" class="main-content-area"><div class="app-container"><div id="initialLoginView" class="container view-section"><h1>Shift Scheduler Login</h1><div class="input-group"><label for="loginUserSelect">Select Your Name:</label><select id="loginUserSelect"><option value="">-- Select Name --</option></select></div><div class="input-group"><label for="loginPassword">Password:</label><input type="password" id="loginPassword"></div><button id="coworkerLoginBtn">Login</button><p id="initialLoginError" class="error-message"></p></div></div></div>
        <div id="userShiftViewWrapper" class="main-content-area hidden"><div class="app-container"><div id="latestPublishedScheduleSection" class="container hidden"><h2 id="latestPublishedScheduleTitle">Latest Published Schedule</h2><table id="latestPublishedScheduleTable"><thead><tr><th>Day</th><th>9:30 - 13:00</th><th>13:00 - 16:30</th></tr></thead><tbody></tbody></table></div><div id="userShiftView" class="container view-section"><div class="top-bar"><h2 id="welcomeUserName">Welcome, [User]!</h2><div><button id="accessManagerPanelBtn" class="secondary hidden">Manager Panel</button><button id="userLogoutBtn" class="secondary">Logout</button></div></div><p style="text-align:center;" id="userWeekDisplay">Application Week: </p><h3>Available Shifts & Your Applications</h3><table id="userShiftsTable"><thead><tr><th>Day</th><th>Date</th><th>Time</th><th>Status</th><th>Your Status / Assigned</th><th>Action</th></tr></thead><tbody></tbody></table></div></div></div>
        <div id="managerDashboardView" class="manager-dashboard hidden"><div class="manager-top-bar"><h1>Manager Dashboard</h1><div><span id="managerLoggedInAs" style="margin-right:20px;"></span><button id="switchToUserViewBtn" class="secondary small-action">My Shifts View</button><button id="managerDashboardLogoutBtn" class="secondary small-action">Logout</button></div></div><div class="manager-body"><div class="manager-sidebar"><h4>Week Navigation</h4><div class="week-navigation"><button id="prevWeekBtnMgr" class="small-action">« Prev Wk</button><button id="jumpToTargetWeekBtnMgr" class="small-action">Next Wk</button><button id="nextWeekBtnMgr" class="small-action">Further Wk »</button></div><p style="text-align:center; font-size:0.9em; margin-bottom:5px;" id="managerSidebarWeekDisplay"></p><hr><h4>Week Actions</h4><button id="publishWeekBtn" class="publish small-action" style="width:100%; margin-bottom:5px;">Publish Week</button><div id="publishStatusIndicator" class="published-status-indicator">Status: Not Published</div><hr><h4>Admin Settings</h4><button id="showChangeMasterPassBtn" class="secondary small-action" style="width:100%; margin-bottom:10px;">Change Master Password</button><button id="resetAllDataBtn" class="delete small-action" style="width:100%;">Reset All Data</button></div><div class="manager-main-content"><div id="changeMasterPasswordSection" class="container hidden" style="border: 1px solid #ffc107; background: #fff9e6;"><h3>Change Master Admin Password</h3><div class="input-group"><label for="currentMasterPassword">Current Master Password:</label><input type="password" id="currentMasterPassword"></div><div class="input-group"><label for="newMasterPassword">New Master Password:</label><input type="password" id="newMasterPassword"></div><div class="input-group"><label for="confirmNewMasterPassword">Confirm New Password:</label><input type="password" id="confirmNewMasterPassword"></div><button id="submitChangeMasterPassBtn">Change Password</button><button id="cancelChangeMasterPassBtn" class="secondary">Cancel</button><p id="changeMasterPassError" class="error-message"></p><p id="changeMasterPassSuccess" class="success-message"></p></div><div class="manager-schedule-preview"><h3 id="managerSchedulePreviewTitle">Shift Schedule Preview: Week of [Date]</h3><table id="managerSchedulePreviewTable"><thead><tr><th>Day</th><th>9:30 - 13:00</th><th>13:00 - 16:30</th></tr></thead><tbody></tbody></table></div><div class="manager-main-flex-row"><div class="manager-applications-column"><h3>Shift Applications Management</h3><p style="text-align:center; font-size:0.9em;" id="managerApplicationWeekDisplay"></p><table id="managerShiftsTable"><thead><tr><th>Day</th><th>Date</th><th>Time</th><th>Status</th><th>Applicants / Assigned</th><th>Actions</th></tr></thead><tbody></tbody></table></div><div class="manager-hours-column"><h3>Hours Overview</h3><div class="input-group" style="margin-bottom:5px;"><select id="hoursViewTypeSelect"><option value="weekly">Weekly Hours</option><option value="monthly">Monthly Hours</option></select></div><div id="hoursOverviewList"></div></div></div><h3>Manage Coworkers</h3><div class="input-group"><label for="newCoworkerName">Add Name:</label><input type="text" id="newCoworkerName" placeholder="Coworker's name"><label for="newCoworkerPassword" style="margin-top:5px;">Set Password:</label><input type="password" id="newCoworkerPassword" placeholder="Initial password"><label style="margin-top:5px;"><input type="checkbox" id="newCoworkerIsManager"> Is Manager?</label><button id="addCoworkerBtn" style="margin-top:10px;">Add Coworker</button></div><div id="coworkerList"></div><div id="totalHoursSummarySection" class="container"><h3>Total Hours Summary per Coworker</h3><div class="input-group"><label for="totalHoursPeriodSelect" style="display:inline-block; margin-right:10px;">Select Period:</label><select id="totalHoursPeriodSelect"><option value="viewing_week">Currently Viewed Week</option><option value="viewing_month">Currently Viewed Month</option><option value="all_loaded">All Loaded Data</option></select></div><table id="totalHoursSummaryTable"><thead><tr><th>Coworker</th><th>Total Approved Hours</th></tr></thead><tbody></tbody></table></div></div></div></div>
        <div id="managerUnlockModal" class="hidden" style="position:fixed; top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center;"><div style="background:white; padding:30px; border-radius:8px; box-shadow: 0 0 15px rgba(0,0,0,0.3); text-align:center;"><h3>Manager Panel Access</h3><p>Enter Master Admin Password:</p><input type="password" id="masterManagerPasswordInput" style="padding:10px; margin-bottom:15px; width:200px;"><br><button id="unlockManagerPanelBtn">Unlock</button><button id="cancelManagerUnlockBtn" class="secondary">Cancel</button><p id="managerUnlockError" class="error-message"></p></div></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> -->

    <script>
        // Your Firebase project configuration - REPLACE WITH YOUR ACTUAL VALUES
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDkJwykLgHJknOjhsplI_BC77DZJ1wc3Sc",
  authDomain: "makersplayce-shift-planner.firebaseapp.com",
  databaseURL: "https://makersplayce-shift-planner-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "makersplayce-shift-planner",
  storageBucket: "makersplayce-shift-planner.firebasestorage.app",
  messagingSenderId: "484080846181",
  appId: "1:484080846181:web:3120dd6711d51a6e8f4d8c",
  measurementId: "G-171W3Y9YQB"
};

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- SCRIPT CONSTANTS AND VARIABLES START HERE ---
        const DEFAULT_MASTER_PASSWORD = "superadmin";
        const ACTIVE_SESSION_USER_KEY = "activeShiftUser_v7_firebase";
        const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const workDays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
        const shiftTimes = ["9:30 - 13:00", "13:00 - 16:30"];
        const SHIFT_DURATION_HOURS = 3.5;

        let currentMasterPassword = DEFAULT_MASTER_PASSWORD;
        let coworkers = [];
        let loggedInCoworker = null;
        let isManagerModeActive = false;
        let currentViewingDateMgr;

        // DOM Elements
        const initialLoginViewWrapper = document.getElementById('initialLoginViewWrapper');
        const loginUserSelect = document.getElementById('loginUserSelect');
        const loginPasswordInput = document.getElementById('loginPassword');
        const coworkerLoginBtn = document.getElementById('coworkerLoginBtn');
        const initialLoginError = document.getElementById('initialLoginError');
        const userShiftViewWrapper = document.getElementById('userShiftViewWrapper');
        const latestPublishedScheduleSection = document.getElementById('latestPublishedScheduleSection');
        const latestPublishedScheduleTitle = document.getElementById('latestPublishedScheduleTitle');
        const latestPublishedScheduleTableBody = document.getElementById('latestPublishedScheduleTable').getElementsByTagName('tbody')[0];
        const welcomeUserName = document.getElementById('welcomeUserName');
        const accessManagerPanelBtn = document.getElementById('accessManagerPanelBtn');
        const userLogoutBtn = document.getElementById('userLogoutBtn');
        const userWeekDisplay = document.getElementById('userWeekDisplay');
        const userShiftsTableBody = document.getElementById('userShiftsTable').getElementsByTagName('tbody')[0];
        const managerUnlockModal = document.getElementById('managerUnlockModal');
        const masterManagerPasswordInput = document.getElementById('masterManagerPasswordInput');
        const unlockManagerPanelBtn = document.getElementById('unlockManagerPanelBtn');
        const cancelManagerUnlockBtn = document.getElementById('cancelManagerUnlockBtn');
        const managerUnlockError = document.getElementById('managerUnlockError');
        const managerDashboardView = document.getElementById('managerDashboardView');
        const managerLoggedInAs = document.getElementById('managerLoggedInAs');
        const switchToUserViewBtn = document.getElementById('switchToUserViewBtn');
        const managerDashboardLogoutBtn = document.getElementById('managerDashboardLogoutBtn');
        const prevWeekBtnMgr = document.getElementById('prevWeekBtnMgr');
        const jumpToTargetWeekBtnMgr = document.getElementById('jumpToTargetWeekBtnMgr');
        const nextWeekBtnMgr = document.getElementById('nextWeekBtnMgr');
        const publishWeekBtn = document.getElementById('publishWeekBtn');
        const publishStatusIndicator = document.getElementById('publishStatusIndicator');
        const showChangeMasterPassBtn = document.getElementById('showChangeMasterPassBtn');
        const changeMasterPasswordSection = document.getElementById('changeMasterPasswordSection');
        const currentMasterPasswordInput = document.getElementById('currentMasterPassword');
        const newMasterPasswordInput = document.getElementById('newMasterPassword');
        const confirmNewMasterPasswordInput = document.getElementById('confirmNewMasterPassword');
        const submitChangeMasterPassBtn = document.getElementById('submitChangeMasterPassBtn');
        const cancelChangeMasterPassBtn = document.getElementById('cancelChangeMasterPassBtn');
        const changeMasterPassError = document.getElementById('changeMasterPassError');
        const changeMasterPassSuccess = document.getElementById('changeMasterPassSuccess');
        const managerSidebarWeekDisplay = document.getElementById('managerSidebarWeekDisplay');
        const hoursViewTypeSelect = document.getElementById('hoursViewTypeSelect');
        const hoursOverviewList = document.getElementById('hoursOverviewList');
        const resetAllDataBtn = document.getElementById('resetAllDataBtn');
        const managerSchedulePreviewTitle = document.getElementById('managerSchedulePreviewTitle');
        const managerSchedulePreviewTableBody = document.getElementById('managerSchedulePreviewTable').getElementsByTagName('tbody')[0];
        const managerApplicationWeekDisplay = document.getElementById('managerApplicationWeekDisplay');
        const managerShiftsTableBody = document.getElementById('managerShiftsTable').getElementsByTagName('tbody')[0];
        const newCoworkerNameInput = document.getElementById('newCoworkerName');
        const newCoworkerPasswordInput = document.getElementById('newCoworkerPassword');
        const newCoworkerIsManagerCheckbox = document.getElementById('newCoworkerIsManager');
        const addCoworkerBtn = document.getElementById('addCoworkerBtn');
        const coworkerListDiv = document.getElementById('coworkerList');
        const totalHoursPeriodSelect = document.getElementById('totalHoursPeriodSelect');
        const totalHoursSummaryTableBody = document.getElementById('totalHoursSummaryTable').getElementsByTagName('tbody')[0];

        // --- Date & Utility Functions ---
        function getMondayOfDate(d) { d = new Date(d); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); const monday = new Date(d.setDate(diff)); monday.setHours(0,0,0,0); return monday; }
        function getNextWeekStartDate(fromDate = new Date()) { const monday = getMondayOfDate(fromDate); monday.setDate(monday.getDate() + 7); return monday; }
        function formatDate(dateObj, includeDayName = true) { if (!dateObj || !(dateObj instanceof Date) || isNaN(dateObj.getTime())) return 'Invalid Date'; const dayStr = includeDayName ? `${dayNames[dateObj.getDay()]}, ` : ''; return `${dayStr}${dateObj.toLocaleString('default', { month: 'short' })} ${dateObj.getDate()}, ${dateObj.getFullYear()}`; }
        function getWeekKey(dateObj) { return getMondayOfDate(dateObj).toISOString().split('T')[0]; }
        
        // --- Initialization ---
                async function initializeApp() {
            try {
                await loadMasterPassword();
                currentViewingDateMgr = getNextWeekStartDate();
                await initializeCoworkers(); 
                
                // ADD THIS LOGGING:
                console.log("Content of global 'coworkers' array right before populating dropdown:", JSON.stringify(coworkers));
                console.log("Length of global 'coworkers' array:", coworkers.length);

                populateLoginUserDropdown(); 
                checkActiveSession();
            } catch (error) {
                console.error("Error during app initialization:", error);
                initialLoginError.textContent = "Failed to initialize. Check console for details.";
            }
        }

        async function loadMasterPassword() {
            try {
                const configRef = db.collection('config').doc('adminConfig');
                const doc = await configRef.get();
                if (doc.exists && doc.data().masterAdminPassword) {
                    currentMasterPassword = doc.data().masterAdminPassword;
                } else {
                    console.warn("Admin config or master password not found in Firestore. Using default and attempting to save.");
                    currentMasterPassword = DEFAULT_MASTER_PASSWORD;
                    try {
                       await configRef.set({ masterAdminPassword: DEFAULT_MASTER_PASSWORD }, { merge: true });
                       console.log("Default master password saved to Firestore config.");
                    } catch (setConfigError) {
                        console.error("Could not save default master password to Firestore:", setConfigError);
                    }
                }
            } catch (error) {
                console.error("Error loading master password from Firestore:", error);
                currentMasterPassword = DEFAULT_MASTER_PASSWORD;
            }
        }

        async function getWeekData(weekStartDate) {
            const weekKey = getWeekKey(weekStartDate);
            const weekDocRef = db.collection('shifts').doc(weekKey);
            try {
                const doc = await weekDocRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    if (!data.shifts) data.shifts = [];
                    data.shifts.forEach(s => { if (s.applicants === undefined) s.applicants = []; });
                    return data;
                } else {
                    console.log(`Week data for ${weekKey} not found, generating...`);
                    const newWeekShifts = [];
                    let idCounter = Date.now();
                    for (let i = 0; i < workDays.length; i++) {
                        const dayName = workDays[i];
                        const shiftDate = new Date(weekStartDate);
                        shiftDate.setDate(weekStartDate.getDate() + i);
                        shiftTimes.forEach(time => {
                            newWeekShifts.push({ id: `${weekKey}-${idCounter++}`, day: dayName, date: shiftDate.toISOString(), time: time, status: "available", applicants: [], applicantName: "" });
                        });
                    }
                    const newWeekData = { shifts: newWeekShifts, isPublished: false };
                    await weekDocRef.set(newWeekData);
                    return newWeekData;
                }
            } catch (error) {
                console.error(`Error getting week data for ${weekKey}:`, error);
                throw new Error(`Could not load/generate shift data for ${weekKey}.`);
            }
        }
        async function getShiftsForWeek(weekStartDate) { const weekData = await getWeekData(weekStartDate); return weekData.shifts; }
        
        async function initializeCoworkers() {
            try {
                const snapshot = await db.collection('coworkers').get();
                if (snapshot.empty) {
                    console.log('No coworkers in Firestore. Initializing with defaults & saving.');
                    coworkers = [ { name: "Ties", password: "1234", isManager: true }, { name: "Joep", password: "1234", isManager: false }, { name: "Jesper", password: "1234", isManager: false }, { name: "Inti", password: "1234", isManager: false }, { name: "Martijn", password: "1234", isManager: false }, { name: "Mathijs", password: "1234", isManager: false }, { name: "Dominik", password: "1234", isManager: false }, { name: "Jippe", password: "1234", isManager: false }, { name: "Zeynep", password: "1234", isManager: false } ];
                    const batch = db.batch();
                    coworkers.forEach(cw => { const docRef = db.collection('coworkers').doc(cw.name); batch.set(docRef, cw); });
                    await batch.commit();
                    console.log('Default coworkers saved to Firestore.');
                } else {
                    coworkers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
            } catch (error) { console.error("Error initializing coworkers:", error); coworkers = []; throw error; }
        }

        // --- View Switching & Session ---
        function showCorrectView() { [initialLoginViewWrapper, userShiftViewWrapper, managerDashboardView, managerUnlockModal, changeMasterPasswordSection].forEach(v => v.classList.add('hidden')); if (isManagerModeActive && loggedInCoworker && loggedInCoworker.isManager) { managerDashboardView.classList.remove('hidden'); managerLoggedInAs.textContent = `Logged in as: ${loggedInCoworker.name}`; refreshManagerDashboard(); } else if (loggedInCoworker) { userShiftViewWrapper.classList.remove('hidden'); prepareUserView(); } else { initialLoginViewWrapper.classList.remove('hidden'); } }
        function checkActiveSession() { const activeUserJSON = localStorage.getItem(ACTIVE_SESSION_USER_KEY); if (activeUserJSON) { const activeUser = JSON.parse(activeUserJSON); const foundCoworker = coworkers.find(c => c.name === activeUser.name); if (foundCoworker) { if(activeUser.password === foundCoworker.password){ loggedInCoworker = foundCoworker; } else { logout(); return; } } else { logout(); return; } } showCorrectView(); }
        function populateLoginUserDropdown() { loginUserSelect.innerHTML = '<option value="">-- Select Name --</option>'; coworkers.sort((a, b) => a.name.localeCompare(b.name)).forEach(coworker => { const option = document.createElement('option'); option.value = coworker.name; option.textContent = coworker.name; loginUserSelect.appendChild(option); }); }
        
        // --- Login/Logout & Manager Unlock ---
        function handleCoworkerLogin() { const selectedName = loginUserSelect.value; const password = loginPasswordInput.value; initialLoginError.textContent = ""; if (!selectedName || !password) { initialLoginError.textContent = "Name and password are required."; return; } const coworker = coworkers.find(c => c.name === selectedName); if (coworker && coworker.password === password) { loggedInCoworker = coworker; localStorage.setItem(ACTIVE_SESSION_USER_KEY, JSON.stringify({name: coworker.name, password: coworker.password})); loginPasswordInput.value = ""; isManagerModeActive = false; showCorrectView(); } else { initialLoginError.textContent = "Invalid name or password."; loginPasswordInput.value = ""; } }
        function handleAccessManagerPanel() { if (loggedInCoworker && loggedInCoworker.isManager) { managerUnlockModal.classList.remove('hidden'); masterManagerPasswordInput.value = ""; managerUnlockError.textContent = ""; masterManagerPasswordInput.focus(); } }
        function handleUnlockManagerPanel() { if (masterManagerPasswordInput.value === currentMasterPassword) { isManagerModeActive = true; managerUnlockModal.classList.add('hidden'); showCorrectView(); } else { managerUnlockError.textContent = "Incorrect Master Password."; } }
        function logout() { loggedInCoworker = null; isManagerModeActive = false; localStorage.removeItem(ACTIVE_SESSION_USER_KEY); loginPasswordInput.value = ""; masterManagerPasswordInput.value = ""; initialLoginError.textContent = ""; managerUnlockError.textContent = ""; changeMasterPasswordSection.classList.add('hidden'); showCorrectView(); }

        async function prepareUserView() {
            if (!loggedInCoworker) return;
            welcomeUserName.textContent = `Welcome, ${loggedInCoworker.name}!`;
            accessManagerPanelBtn.classList.toggle('hidden', !loggedInCoworker.isManager);
            try {
                const querySnapshot = await db.collection('shifts').where('isPublished', '==', true).orderBy(firebase.firestore.FieldPath.documentId(), 'desc').limit(1).get();
                if (!querySnapshot.empty) {
                    const latestPublishedWeekData = querySnapshot.docs[0].data();
                    const latestPublishedWeekKey = querySnapshot.docs[0].id;
                    latestPublishedScheduleTitle.textContent = `Latest Published Schedule: Week of ${formatDate(new Date(latestPublishedWeekKey), false)}`;
                    renderScheduleOverview(latestPublishedWeekData.shifts, latestPublishedScheduleTableBody);
                    latestPublishedScheduleSection.classList.remove('hidden');
                } else {
                    latestPublishedScheduleSection.classList.add('hidden');
                }
                const applicationWeekStartDate = getNextWeekStartDate();
                userWeekDisplay.textContent = `Application Week: ${formatDate(applicationWeekStartDate, false)}`;
                const shiftsToDisplayForApplication = await getShiftsForWeek(applicationWeekStartDate);
                renderUserShifts(shiftsToDisplayForApplication, applicationWeekStartDate);
            } catch (error) { console.error("Error preparing user view:", error); userWeekDisplay.textContent = "Error loading shifts."; }
        }

        // --- Rendering Logic ---
        function renderUserShifts(shiftsForWeek, forWeekDate) { userShiftsTableBody.innerHTML = ""; shiftsForWeek.forEach(shift => { const row = userShiftsTableBody.insertRow(); row.insertCell().textContent = shift.day; row.insertCell().textContent = formatDate(new Date(shift.date), false); row.insertCell().textContent = shift.time; const statusCell = row.insertCell(); const applicantsAssignedCell = row.insertCell(); const actionCell = row.insertCell(); const isMyAppPending = shift.status === 'pending' && shift.applicants.includes(loggedInCoworker.name); const isApproved = shift.status === 'approved'; if (isApproved) { statusCell.textContent = "Approved"; statusCell.className = 'status-approved'; applicantsAssignedCell.textContent = shift.applicantName; actionCell.textContent = "---"; } else if (isMyAppPending) { statusCell.textContent = "Pending"; statusCell.className = 'status-pending'; applicantsAssignedCell.textContent = loggedInCoworker.name; const cancelBtn = document.createElement('button'); cancelBtn.textContent = "Cancel App"; cancelBtn.classList.add("deny"); cancelBtn.onclick = () => cancelApplication(shift.id, getWeekKey(forWeekDate)); actionCell.appendChild(cancelBtn); } else { statusCell.textContent = "Available"; statusCell.className = 'status-available'; applicantsAssignedCell.textContent = "---"; const applyButton = document.createElement('button'); applyButton.textContent = "Apply"; applyButton.classList.add("apply"); applyButton.onclick = () => applyForShift(shift.id, getWeekKey(forWeekDate)); actionCell.appendChild(applyButton); } }); }
        function renderScheduleOverview(shiftsForWeek, tableBodyElement) { tableBodyElement.innerHTML = ""; const scheduleData = {}; workDays.forEach(day => { scheduleData[day] = {}; shiftTimes.forEach(time => scheduleData[day][time] = "Unassigned"); }); shiftsForWeek.filter(s => s.status === "approved").forEach(shift => { if (scheduleData[shift.day]) scheduleData[shift.day][shift.time] = shift.applicantName; }); workDays.forEach(day => { const row = tableBodyElement.insertRow(); const dayCell = row.insertCell(); const shiftOnThisDay = shiftsForWeek.find(s => s.day === day); dayCell.innerHTML = `${day}<br><small>${shiftOnThisDay ? formatDate(new Date(shiftOnThisDay.date), false) : ''}</small>`; shiftTimes.forEach(time => { const cell = row.insertCell(); cell.textContent = scheduleData[day][time] || "Unassigned"; if (scheduleData[day][time] && scheduleData[day][time] !== "Unassigned") { cell.style.fontWeight = "bold"; } }); }); }
        async function refreshManagerDashboard() { if (!isManagerModeActive) return; try { const weekData = await getWeekData(currentViewingDateMgr); const shiftsForViewingWeek = weekData.shifts; managerSidebarWeekDisplay.textContent = `Week: ${formatDate(currentViewingDateMgr, false)}`; managerApplicationWeekDisplay.textContent = `Apps for week: ${formatDate(currentViewingDateMgr, false)}`; managerSchedulePreviewTitle.textContent = `Schedule: Week of ${formatDate(currentViewingDateMgr, false)}`; renderManagerApplications(shiftsForViewingWeek); renderScheduleOverview(shiftsForViewingWeek, managerSchedulePreviewTableBody); renderCoworkerListForManager(); renderHoursOverview(shiftsForViewingWeek); await renderTotalHoursSummary(); if (weekData.isPublished) { publishWeekBtn.textContent = "Unpublish Week"; publishWeekBtn.classList.remove("publish"); publishWeekBtn.classList.add("deny"); publishStatusIndicator.textContent = "Status: Published"; publishStatusIndicator.style.color = "green"; } else { publishWeekBtn.textContent = "Publish Week"; publishWeekBtn.classList.add("publish"); publishWeekBtn.classList.remove("deny"); publishStatusIndicator.textContent = "Status: Not Published"; publishStatusIndicator.style.color = "orange"; } } catch (error) { console.error("Error refreshing manager dashboard:", error); } }
        function renderManagerApplications(shiftsForWeek) { managerShiftsTableBody.innerHTML = ""; shiftsForWeek.forEach(shift => { const row = managerShiftsTableBody.insertRow(); row.insertCell().textContent = shift.day; row.insertCell().textContent = formatDate(new Date(shift.date), false); row.insertCell().textContent = shift.time; const statusCell = row.insertCell(); statusCell.textContent = shift.status.charAt(0).toUpperCase() + shift.status.slice(1); statusCell.className = `status-${shift.status}`; let applicantDisplay = "---"; if (shift.status === "pending" && shift.applicants && shift.applicants.length > 0) { applicantDisplay = shift.applicants.join(', '); } else if (shift.status === "approved") { applicantDisplay = shift.applicantName; } row.insertCell().textContent = applicantDisplay; const actionCell = row.insertCell(); actionCell.classList.add("action-cell"); const weekKey = getWeekKey(new Date(shift.date)); if (shift.status === "pending" && shift.applicants && shift.applicants.length > 0) { const applicantSelect = document.createElement('select'); applicantSelect.id = `select-pending-${shift.id}`; shift.applicants.forEach(appName => { const option = document.createElement('option'); option.value = appName; option.textContent = appName; applicantSelect.appendChild(option); }); actionCell.appendChild(applicantSelect); const approveSelectedBtn = document.createElement('button'); approveSelectedBtn.textContent = "Approve Sel."; approveSelectedBtn.classList.add("approve", "small-action"); approveSelectedBtn.onclick = () => { const selectedName = document.getElementById(`select-pending-${shift.id}`).value; managerApproveSelectedApplicant(shift.id, weekKey, selectedName); }; actionCell.appendChild(approveSelectedBtn); const denyAllBtn = document.createElement('button'); denyAllBtn.textContent = "Deny All"; denyAllBtn.classList.add("deny", "small-action"); denyAllBtn.style.marginLeft = "5px"; denyAllBtn.onclick = () => managerDenyAllApplicants(shift.id, weekKey); actionCell.appendChild(denyAllBtn); } else if (shift.status === "approved") { const clearBtn = document.createElement('button'); clearBtn.textContent = "Clear"; clearBtn.classList.add("deny", "small-action"); clearBtn.onclick = () => managerClearApprovedShift(shift.id, weekKey); actionCell.appendChild(clearBtn); actionCell.appendChild(document.createElement('hr')); } if (shift.status === "available" || shift.status === "approved") { const manualAssignSelect = document.createElement('select'); manualAssignSelect.id = `select-manual-${shift.id}`; manualAssignSelect.innerHTML = '<option value="">-- Assign To --</option>'; coworkers.forEach(cw => { const option = document.createElement('option'); option.value = cw.name; option.textContent = cw.name; manualAssignSelect.appendChild(option); }); actionCell.appendChild(manualAssignSelect); const manualAssignBtn = document.createElement('button'); manualAssignBtn.textContent = "Assign"; manualAssignBtn.classList.add("assign", "small-action"); manualAssignBtn.onclick = () => { const selectedName = document.getElementById(`select-manual-${shift.id}`).value; if (selectedName) { managerManuallyAssignShift(shift.id, weekKey, selectedName); } else { alert("Please select a coworker to assign."); } }; actionCell.appendChild(manualAssignBtn); } }); }
        function renderHoursOverview(shiftsForViewingWeek) { hoursOverviewList.innerHTML = ""; const type = hoursViewTypeSelect.value; const hoursData = {}; coworkers.forEach(c => hoursData[c.name] = 0); if (type === "weekly") { shiftsForViewingWeek.filter(s => s.status === "approved" && s.applicantName).forEach(s => { if (hoursData.hasOwnProperty(s.applicantName)) { hoursData[s.applicantName] += SHIFT_DURATION_HOURS; } }); } else if (type === "monthly") { const targetMonth = currentViewingDateMgr.getMonth(); const targetYear = currentViewingDateMgr.getFullYear(); shiftsForViewingWeek.filter(s => s.status === "approved" && s.applicantName && new Date(s.date).getMonth() === targetMonth && new Date(s.date).getFullYear() === targetYear).forEach(s => { if (hoursData.hasOwnProperty(s.applicantName)) { hoursData[s.applicantName] += SHIFT_DURATION_HOURS; } }); } const sortedCoworkers = Object.keys(hoursData).sort(); sortedCoworkers.forEach(name => { const item = document.createElement('div'); item.classList.add('hours-overview-item'); item.textContent = `${name}: ${hoursData[name].toFixed(1)} hrs`; hoursOverviewList.appendChild(item); }); }
        async function renderTotalHoursSummary() { totalHoursSummaryTableBody.innerHTML = ""; const period = totalHoursPeriodSelect.value; const summaryData = {}; coworkers.forEach(c => summaryData[c.name] = 0); let shiftsToConsider = []; if (period === "viewing_week") { shiftsToConsider = await getShiftsForWeek(currentViewingDateMgr); } else if (period === "viewing_month") { const targetMonth = currentViewingDateMgr.getMonth(); const targetYear = currentViewingDateMgr.getFullYear(); try { const querySnapshot = await db.collection('shifts').get(); querySnapshot.forEach(doc => { const weekKey = doc.id; const weekStartDate = new Date(weekKey); if(weekStartDate.getMonth() === targetMonth && weekStartDate.getFullYear() === targetYear) { shiftsToConsider = shiftsToConsider.concat(doc.data().shifts); } }); } catch (e) { console.error("Error fetching all weeks for monthly summary", e);}} else if (period === "all_loaded") { try { const querySnapshot = await db.collection('shifts').get(); querySnapshot.forEach(doc => { shiftsToConsider = shiftsToConsider.concat(doc.data().shifts); }); } catch (e) { console.error("Error fetching all weeks for all_loaded summary", e); }} shiftsToConsider.filter(s => s.status === "approved" && s.applicantName).forEach(s => { if (summaryData.hasOwnProperty(s.applicantName)) { summaryData[s.applicantName] += SHIFT_DURATION_HOURS; } }); const sortedCoworkerNames = Object.keys(summaryData).sort(); sortedCoworkerNames.forEach(name => { const row = totalHoursSummaryTableBody.insertRow(); row.insertCell().textContent = name; row.insertCell().textContent = summaryData[name].toFixed(1) + " hrs"; }); }

        // --- Shift Actions (Writes to Firestore) ---
        async function applyForShift(shiftId, weekKey) {
            if (!loggedInCoworker) { alert("You must be logged in to apply."); return; }
            const weekDocRef = db.collection('shifts').doc(weekKey);
            try {
                await db.runTransaction(async (transaction) => {
                    const weekDoc = await transaction.get(weekDocRef);
                    if (!weekDoc.exists) throw "Shift data for this week not found!";
                    const weekData = weekDoc.data();
                    const shiftIndex = weekData.shifts.findIndex(s => s.id === shiftId);
                    if (shiftIndex === -1) throw "Shift not found!";
                    const shift = weekData.shifts[shiftIndex];
                    if (shift.status === 'approved') { alert("This shift is already approved."); return; }
                    if (shift.applicants.includes(loggedInCoworker.name)) { alert("You have already applied."); return; }
                    weekData.shifts[shiftIndex].applicants.push(loggedInCoworker.name);
                    weekData.shifts[shiftIndex].status = "pending";
                    weekData.shifts[shiftIndex].applicantName = "";
                    transaction.update(weekDocRef, { shifts: weekData.shifts });
                });
                await prepareUserView(); if (isManagerModeActive) await refreshManagerDashboard();
            } catch (error) { console.error("Error applying for shift:", error); alert("Failed to apply: " + error); }
        }
        async function cancelApplication(shiftId, weekKey) {
            if (!loggedInCoworker) return;
            const weekDocRef = db.collection('shifts').doc(weekKey);
            try {
                await db.runTransaction(async (transaction) => {
                    const weekDoc = await transaction.get(weekDocRef);
                    if (!weekDoc.exists) throw "Shift data for this week not found!";
                    const weekData = weekDoc.data();
                    const shiftIndex = weekData.shifts.findIndex(s => s.id === shiftId);
                    if (shiftIndex === -1) throw "Shift not found!";
                    const shift = weekData.shifts[shiftIndex];
                    if (shift.status !== 'pending' || !shift.applicants.includes(loggedInCoworker.name)) { alert("Cannot cancel this application."); return; }
                    weekData.shifts[shiftIndex].applicants = shift.applicants.filter(name => name !== loggedInCoworker.name);
                    if (weekData.shifts[shiftIndex].applicants.length === 0) { weekData.shifts[shiftIndex].status = "available"; }
                    transaction.update(weekDocRef, { shifts: weekData.shifts });
                });
                await prepareUserView(); if (isManagerModeActive) await refreshManagerDashboard();
            } catch (error) { console.error("Error cancelling application:", error); alert("Failed to cancel application: " + error); }
        }
        async function managerApproveSelectedApplicant(shiftId, weekKey, selectedApplicantName) {
            const weekDocRef = db.collection('shifts').doc(weekKey);
            try {
                await db.runTransaction(async (transaction) => {
                    const weekDoc = await transaction.get(weekDocRef);
                    if (!weekDoc.exists) throw "Shift data for this week not found!";
                    const weekData = weekDoc.data();
                    const shiftIndex = weekData.shifts.findIndex(s => s.id === shiftId);
                    if (shiftIndex === -1) throw "Shift not found!";
                    if (weekData.shifts[shiftIndex].status !== 'pending') { alert("Shift is not pending approval."); return; }
                    weekData.shifts[shiftIndex].status = "approved";
                    weekData.shifts[shiftIndex].applicantName = selectedApplicantName;
                    weekData.shifts[shiftIndex].applicants = [];
                    transaction.update(weekDocRef, { shifts: weekData.shifts });
                });
                await refreshManagerDashboard(); await prepareUserView();
            } catch (error) { console.error("Error approving shift:", error); alert("Failed to approve shift: " + error); }
        }
        async function managerDenyAllApplicants(shiftId, weekKey) {
            const weekDocRef = db.collection('shifts').doc(weekKey);
            try {
                await db.runTransaction(async (transaction) => {
                    const weekDoc = await transaction.get(weekDocRef);
                    if (!weekDoc.exists) throw "Shift data for this week not found!";
                    const weekData = weekDoc.data();
                    const shiftIndex = weekData.shifts.findIndex(s => s.id === shiftId);
                    if (shiftIndex === -1) throw "Shift not found!";
                    weekData.shifts[shiftIndex].status = "available";
                    weekData.shifts[shiftIndex].applicantName = "";
                    weekData.shifts[shiftIndex].applicants = [];
                    transaction.update(weekDocRef, { shifts: weekData.shifts });
                });
                await refreshManagerDashboard(); await prepareUserView();
            } catch (error) { console.error("Error denying applicants:", error); alert("Failed to deny applicants: " + error); }
        }
        async function managerClearApprovedShift(shiftId, weekKey) {
            const weekDocRef = db.collection('shifts').doc(weekKey);
            try {
                await db.runTransaction(async (transaction) => {
                    const weekDoc = await transaction.get(weekDocRef);
                    if (!weekDoc.exists) throw "Shift data for this week not found!";
                    const weekData = weekDoc.data();
                    const shiftIndex = weekData.shifts.findIndex(s => s.id === shiftId);
                    if (shiftIndex === -1) throw "Shift not found!";
                    if (weekData.shifts[shiftIndex].status !== 'approved') { alert("Shift is not currently approved."); return; }
                    weekData.shifts[shiftIndex].status = "available";
                    weekData.shifts[shiftIndex].applicantName = "";
                    weekData.shifts[shiftIndex].applicants = [];
                    transaction.update(weekDocRef, { shifts: weekData.shifts });
                });
                await refreshManagerDashboard(); await prepareUserView();
            } catch (error) { console.error("Error clearing approved shift:", error); alert("Failed to clear approved shift: " + error); }
        }
        async function managerManuallyAssignShift(shiftId, weekKey, coworkerName) {
            if (!coworkerName) { alert("Please select a coworker to assign."); return; }
            const weekDocRef = db.collection('shifts').doc(weekKey);
            try {
                await db.runTransaction(async (transaction) => {
                    const weekDoc = await transaction.get(weekDocRef);
                    if (!weekDoc.exists) throw "Shift data for this week not found!";
                    const weekData = weekDoc.data();
                    const shiftIndex = weekData.shifts.findIndex(s => s.id === shiftId);
                    if (shiftIndex === -1) throw "Shift not found!";
                    weekData.shifts[shiftIndex].status = "approved";
                    weekData.shifts[shiftIndex].applicantName = coworkerName;
                    weekData.shifts[shiftIndex].applicants = [];
                    transaction.update(weekDocRef, { shifts: weekData.shifts });
                });
                await refreshManagerDashboard(); await prepareUserView();
            } catch (error) { console.error("Error manually assigning shift:", error); alert("Failed to manually assign shift: " + error); }
        }
        async function handlePublishWeekToggle() {
            const weekKey = getWeekKey(currentViewingDateMgr);
            const weekDocRef = db.collection('shifts').doc(weekKey);
            try {
                const weekDoc = await weekDocRef.get();
                if (!weekDoc.exists) { alert("Cannot publish/unpublish a non-existent week."); return; }
                const currentIsPublished = weekDoc.data().isPublished;
                await weekDocRef.update({ isPublished: !currentIsPublished });
                alert(`Week of ${formatDate(currentViewingDateMgr, false)} has been ${!currentIsPublished ? 'Published' : 'Unpublished'}.`);
                await refreshManagerDashboard(); await prepareUserView();
            } catch (error) { console.error("Error toggling publish status:", error); alert("Failed to toggle publish status: " + error); }
        }
        
        // --- Manager: Coworker & Master Password (Writes to Firestore) ---
        function renderCoworkerListForManager() { coworkerListDiv.innerHTML = "<h4>Current Coworkers:</h4>"; if (coworkers.length === 0) { coworkerListDiv.innerHTML += "<p>No coworkers.</p>"; return; } const ul = document.createElement('ul'); ul.style.listStyleType = 'none'; ul.style.paddingLeft = '0'; coworkers.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => { const li = document.createElement('li'); li.classList.add('coworker-management-item'); const nameSpan = document.createElement('span'); nameSpan.textContent = `${c.name} ${c.isManager ? '(Mgr)' : ''}`; li.appendChild(nameSpan); const actionDiv = document.createElement('div'); const changePassBtn = document.createElement('button'); changePassBtn.textContent = "Pwd"; changePassBtn.classList.add("secondary", "small-action"); changePassBtn.onclick = () => handleChangeCoworkerPassword(c.id || c.name); actionDiv.appendChild(changePassBtn); const toggleMgrBtn = document.createElement('button'); toggleMgrBtn.textContent = c.isManager ? "Demote" : "Promote"; toggleMgrBtn.classList.add("secondary", "small-action"); toggleMgrBtn.onclick = () => handleToggleManagerStatus(c.id || c.name); actionDiv.appendChild(toggleMgrBtn); const deleteBtn = document.createElement('button'); deleteBtn.textContent = "Del"; deleteBtn.classList.add("delete", "small-action"); deleteBtn.onclick = () => handleDeleteCoworker(c.id || c.name); actionDiv.appendChild(deleteBtn); li.appendChild(actionDiv); ul.appendChild(li); }); coworkerListDiv.appendChild(ul); }
        async function handleAddCoworker() { const name = newCoworkerNameInput.value.trim(); const password = newCoworkerPasswordInput.value; const isManager = newCoworkerIsManagerCheckbox.checked; if (!name || !password) { alert("Name and password required."); return; } if (coworkers.find(c => c.name.toLowerCase() === name.toLowerCase())) { alert("Coworker name already exists."); return; } try { await db.collection('coworkers').doc(name).set({ name, password, isManager }); await initializeCoworkers(); populateLoginUserDropdown(); renderCoworkerListForManager(); newCoworkerNameInput.value = ""; newCoworkerPasswordInput.value = ""; newCoworkerIsManagerCheckbox.checked = false; alert(`${name} added.`); } catch (error) { console.error("Error adding coworker:", error); alert("Failed to add: " + error); } }
        async function handleDeleteCoworker(coworkerDocIdOrName) { const coworkerToDelete = coworkers.find(c => c.id === coworkerDocIdOrName || c.name === coworkerDocIdOrName); if (!coworkerToDelete) { alert("Coworker not found."); return;} if (coworkerToDelete.isManager && coworkers.filter(c => c.isManager).length <= 1) { alert("Cannot delete the last manager."); return; } if (!confirm(`Delete ${coworkerToDelete.name}?`)) return; try { await db.collection('coworkers').doc(coworkerToDelete.id || coworkerToDelete.name).delete(); const shiftsCollectionRef = db.collection('shifts'); const querySnapshot = await shiftsCollectionRef.get(); const batch = db.batch(); let changesMadeToShifts = false; querySnapshot.forEach(weekDoc => { const weekKey = weekDoc.id; const weekData = weekDoc.data(); let weekModified = false; const updatedShifts = weekData.shifts.map(shift => { let shiftChanged = false; if (shift.applicantName === coworkerToDelete.name) { shift.applicantName = ""; shift.status = "available"; shiftChanged = true; } if (shift.applicants && shift.applicants.includes(coworkerToDelete.name)) { shift.applicants = shift.applicants.filter(name => name !== coworkerToDelete.name); if (shift.status === "pending" && shift.applicants.length === 0) { shift.status = "available"; } shiftChanged = true; } if(shiftChanged) weekModified = true; return shift; }); if (weekModified) { batch.update(shiftsCollectionRef.doc(weekKey), { shifts: updatedShifts }); changesMadeToShifts = true; } }); if (changesMadeToShifts) { await batch.commit(); } await initializeCoworkers(); populateLoginUserDropdown(); if (loggedInCoworker && loggedInCoworker.name === coworkerToDelete.name) logout(); else { if (isManagerModeActive) await refreshManagerDashboard(); await prepareUserView(); } alert(`${coworkerToDelete.name} deleted.`); } catch (error) { console.error("Error deleting coworker:", error); alert("Failed to delete: " + error); } }
        async function handleChangeCoworkerPassword(coworkerDocIdOrName) { const newPassword = prompt(`Enter new password for this coworker:`); if (newPassword === null) return; if (!newPassword.trim()) { alert("Password cannot be empty."); return; } try { await db.collection('coworkers').doc(coworkerDocIdOrName).update({ password: newPassword.trim() }); const localCoworker = coworkers.find(c => c.id === coworkerDocIdOrName || c.name === coworkerDocIdOrName); if (localCoworker) localCoworker.password = newPassword.trim(); if (loggedInCoworker && (loggedInCoworker.id === coworkerDocIdOrName || loggedInCoworker.name === coworkerDocIdOrName)) { loggedInCoworker.password = newPassword.trim(); localStorage.setItem(ACTIVE_SESSION_USER_KEY, JSON.stringify({name: loggedInCoworker.name, password: loggedInCoworker.password})); } alert(`Password updated.`); } catch (error) { console.error("Error changing password:", error); alert("Failed to change: " + error); } }
        async function handleToggleManagerStatus(coworkerDocIdOrName) { const coworkerToToggle = coworkers.find(c => c.id === coworkerDocIdOrName || c.name === coworkerDocIdOrName); if (!coworkerToToggle) return; const newManagerStatus = !coworkerToToggle.isManager; if (coworkerToToggle.isManager && coworkers.filter(c => c.isManager).length <= 1) { alert("Cannot demote the last manager."); return; } try { await db.collection('coworkers').doc(coworkerDocIdOrName).update({ isManager: newManagerStatus }); coworkerToToggle.isManager = newManagerStatus; renderCoworkerListForManager(); if (loggedInCoworker && (loggedInCoworker.id === coworkerDocIdOrName || loggedInCoworker.name === coworkerDocIdOrName)) { loggedInCoworker.isManager = newManagerStatus; accessManagerPanelBtn.classList.toggle('hidden', !loggedInCoworker.isManager); if (!loggedInCoworker.isManager && isManagerModeActive) { isManagerModeActive = false; showCorrectView(); } } alert(`Manager status updated for ${coworkerToToggle.name}.`); } catch (error) { console.error("Error toggling manager status:", error); alert("Failed to toggle: " + error); } }
        async function handleSubmitChangeMasterPassword() { changeMasterPassError.textContent = ""; changeMasterPassSuccess.textContent = ""; const currentPassAttempt = currentMasterPasswordInput.value; const newPass = newMasterPasswordInput.value; const confirmPass = confirmNewMasterPasswordInput.value; if (currentPassAttempt !== currentMasterPassword) { changeMasterPassError.textContent = "Current Master Password incorrect."; return; } if (!newPass || newPass.length < 6) { changeMasterPassError.textContent = "New password must be at least 6 characters."; return; } if (newPass !== confirmPass) { changeMasterPassError.textContent = "New passwords do not match."; return; } try { await db.collection('config').doc('adminConfig').set({ masterAdminPassword: newPass }, { merge: true }); currentMasterPassword = newPass; changeMasterPassSuccess.textContent = "Master Admin Password changed successfully!"; currentMasterPasswordInput.value = ""; newMasterPasswordInput.value = ""; confirmNewMasterPasswordInput.value = ""; setTimeout(() => { changeMasterPasswordSection.classList.add('hidden'); changeMasterPassSuccess.textContent = ""; }, 2000); } catch (error) { console.error("Error updating master password:", error); changeMasterPassError.textContent = "Failed to update."; } }
        async function handleResetAllData() { if (confirm("This will clear your local session. Data in Firestore will NOT be deleted by this action. Are you sure?")) { loggedInCoworker = null; isManagerModeActive = false; localStorage.removeItem(ACTIVE_SESSION_USER_KEY); await initializeApp(); alert("Local session reset. App re-initialized from Firestore."); } }
        
        // --- Event Listeners ---
        coworkerLoginBtn.addEventListener('click', handleCoworkerLogin); loginPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleCoworkerLogin(); }); accessManagerPanelBtn.addEventListener('click', handleAccessManagerPanel); userLogoutBtn.addEventListener('click', logout); unlockManagerPanelBtn.addEventListener('click', handleUnlockManagerPanel); masterManagerPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleUnlockManagerPanel(); }); cancelManagerUnlockBtn.addEventListener('click', () => managerUnlockModal.classList.add('hidden')); switchToUserViewBtn.addEventListener('click', () => { isManagerModeActive = false; changeMasterPasswordSection.classList.add('hidden'); showCorrectView(); }); managerDashboardLogoutBtn.addEventListener('click', logout);
        prevWeekBtnMgr.addEventListener('click', () => { currentViewingDateMgr.setDate(currentViewingDateMgr.getDate() - 7); refreshManagerDashboard(); });
        jumpToTargetWeekBtnMgr.addEventListener('click', () => { currentViewingDateMgr = getNextWeekStartDate(); refreshManagerDashboard(); });
        nextWeekBtnMgr.addEventListener('click', () => { currentViewingDateMgr.setDate(currentViewingDateMgr.getDate() + 7); refreshManagerDashboard(); });
        publishWeekBtn.addEventListener('click', handlePublishWeekToggle); showChangeMasterPassBtn.addEventListener('click', () => { changeMasterPasswordSection.classList.toggle('hidden'); changeMasterPassError.textContent = ""; changeMasterPassSuccess.textContent = ""; currentMasterPasswordInput.value = ""; newMasterPasswordInput.value = ""; confirmNewMasterPasswordInput.value = ""; }); submitChangeMasterPassBtn.addEventListener('click', handleSubmitChangeMasterPassword); cancelChangeMasterPassBtn.addEventListener('click', () => { changeMasterPasswordSection.classList.add('hidden'); changeMasterPassError.textContent = ""; changeMasterPassSuccess.textContent = ""; });
        hoursViewTypeSelect.addEventListener('change', () => refreshManagerDashboard());
        totalHoursPeriodSelect.addEventListener('change', () => refreshManagerDashboard());
        resetAllDataBtn.addEventListener('click', handleResetAllData); addCoworkerBtn.addEventListener('click', handleAddCoworker); newCoworkerPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddCoworker(); });
        
        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
